<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Travel Pictures - Admin</title>
    <link rel="stylesheet" href="/assets/css/admin.css" />
  </head>
  <body>
    <div class="header">
      <h1>Travel Pictures - Admin Panel</h1>
      <a href="/" class="nav-link">‚Üê View Public Gallery</a>
    </div>

    <div class="upload-section">
      <h2>Upload New Picture</h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="picture">Select Picture:</label>
          <input type="file" id="picture" name="file" accept="image/*" required />
        </div>
        <div class="form-group">
          <label for="description">Description (optional):</label>
          <textarea
            id="description"
            name="description"
            placeholder="Enter a description for this picture..."
          ></textarea>
        </div>
        <button type="submit" class="upload-btn" id="uploadBtn">Upload Picture</button>
      </form>

      <div id="message" class="message"></div>
    </div>

    <div class="pictures-list">
      <h2>Uploaded Pictures</h2>
      <div id="picturesList">
        <p>Loading pictures...</p>
      </div>
    </div>

    <script>
      // Upload form handling
      document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault()

        const formData = new FormData()
        const fileInput = document.getElementById('picture')
        const descriptionInput = document.getElementById('description')
        const uploadBtn = document.getElementById('uploadBtn')
        const messageDiv = document.getElementById('message')

        if (!fileInput.files[0]) {
          showMessage('Please select a picture to upload.', 'error')
          return
        }

        formData.append('file', fileInput.files[0])
        if (descriptionInput.value.trim()) {
          formData.append('description', descriptionInput.value.trim())
        }

        uploadBtn.disabled = true
        uploadBtn.textContent = 'Uploading...'

        try {
          const response = await fetch('/admin/upload', {
            method: 'POST',
            body: formData,
          })

          const result = await response.json()

          if (response.ok) {
            showMessage('Picture uploaded successfully!', 'success')
            document.getElementById('uploadForm').reset()
            loadPictures() // Reload the pictures list
          } else {
            showMessage(result.detail || 'Upload failed', 'error')
          }
        } catch (error) {
          showMessage('Upload failed: ' + error.message, 'error')
        } finally {
          uploadBtn.disabled = false
          uploadBtn.textContent = 'Upload Picture'
        }
      })

      // Show message function
      function showMessage(text, type) {
        const messageDiv = document.getElementById('message')
        messageDiv.textContent = text
        messageDiv.className = `message ${type}`
        messageDiv.style.display = 'block'

        setTimeout(() => {
          messageDiv.style.display = 'none'
        }, 5000)
      }

      // Load pictures list
      async function loadPictures() {
        try {
          const response = await fetch('/admin/pictures')
          const pictures = await response.json()

          const picturesListDiv = document.getElementById('picturesList')

          if (pictures.length === 0) {
            picturesListDiv.innerHTML = '<p>No pictures uploaded yet.</p>'
            return
          }

          picturesListDiv.innerHTML = pictures
            .map(
              (picture) => `
                    <div class="picture-item">
                        <img src="/pictures/${picture.id}/file" alt="${picture.original_filename}" class="picture-thumbnail">
                        <div class="picture-info">
                            <div class="picture-title">${picture.original_filename}</div>
                            <div class="picture-meta">
                                ${picture.description ? `<div>Description: ${picture.description}</div>` : ''}
                                <div>Uploaded: ${new Date(picture.upload_date).toLocaleDateString()}</div>
                                ${picture.date_taken ? `<div>Taken: ${new Date(picture.date_taken).toLocaleDateString()}</div>` : ''}
                                ${picture.latitude && picture.longitude ? `<div>Location: ${picture.latitude.toFixed(4)}, ${picture.longitude.toFixed(4)}</div>` : ''}
                                <div>Size: ${(picture.file_size / 1024 / 1024).toFixed(2)} MB</div>
                            </div>
                        </div>
                        <button class="delete-btn" onclick="deletePicture(${picture.id})">Delete</button>
                    </div>
                `,
            )
            .join('')
        } catch (error) {
          document.getElementById('picturesList').innerHTML = '<p>Failed to load pictures.</p>'
        }
      }

      // Delete picture function
      async function deletePicture(pictureId) {
        if (!confirm('Are you sure you want to delete this picture?')) {
          return
        }

        try {
          const response = await fetch(`/admin/pictures/${pictureId}`, {
            method: 'DELETE',
          })

          if (response.ok) {
            showMessage('Picture deleted successfully', 'success')
            loadPictures()
          } else {
            const result = await response.json()
            showMessage(result.detail || 'Failed to delete picture', 'error')
          }
        } catch (error) {
          showMessage('Failed to delete picture: ' + error.message, 'error')
        }
      }

      // Load pictures on page load
      loadPictures()
    </script>
  </body>
</html>
