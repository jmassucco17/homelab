<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Where Am I? ‚Äî Travel</title>
    <link rel="stylesheet" href="https://assets.jamesmassucco.com/styles/main.css?v=2.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="/static/css/location.css" />
  </head>
  <body>
    <div id="theme-toggle-container"></div>
    <header class="site-header">
      <div class="container">
        <h1><a href="/">‚úàÔ∏è Travel</a></h1>
        <nav>
          <a href="/">Home</a>
        </nav>
      </div>
    </header>

    <main class="container">
      <div class="page-header">
        <h2>üìç Where Am I?</h2>
      </div>

      <!-- Current location hero -->
      <div class="location-hero">
        <h2>Current Location</h2>
        {% if current %}
        <div class="hero-label">
          {% if current.city %}{{ current.city }},{% endif %}
          {{ current.country or "Unknown" }}
        </div>
        <div class="hero-date">as of {{ current.date.isoformat() }}</div>
        {% else %}
        <div class="hero-unknown">No location data yet ‚Äî import a Takeout file below.</div>
        {% endif %}
      </div>

      <!-- Map -->
      {% if all_locations %}
      <div id="location-map"></div>
      {% endif %}

      <!-- Toggle bar -->
      <div class="toggle-bar">
        <span>View by:</span>
        <a href="?mode=city" class="{% if mode == 'city' %}active{% endif %}">City</a>
        <a href="?mode=country" class="{% if mode == 'country' %}active{% endif %}"
          >Country</a
        >
      </div>

      <!-- History table -->
      {% if groups %}
      <table class="history-table">
        {% if mode == 'city' %}
        <thead>
          <tr>
            <th>Date</th>
            <th>City</th>
            <th>Country</th>
          </tr>
        </thead>
        <tbody>
          {% for g in groups %}
          <tr class="{% if g.latest.date == today %}today-row{% endif %}">
            <td>{{ g.to_date.isoformat() }}</td>
            <td>{{ g.latest.city or "‚Äî" }}</td>
            <td>{{ g.latest.country or "‚Äî" }}</td>
          </tr>
          {% endfor %}
        </tbody>
        {% else %}
        <thead>
          <tr>
            <th>From</th>
            <th>To</th>
            <th>Days</th>
            <th>Location</th>
          </tr>
        </thead>
        <tbody>
          {% for g in groups %}
          <tr class="{% if g.latest.date == today %}today-row{% endif %}">
            <td>{{ g.from_date.isoformat() }}</td>
            <td>{{ g.to_date.isoformat() }}</td>
            <td>{{ g.days }}</td>
            <td>{{ g.label }}</td>
          </tr>
          {% endfor %}
        </tbody>
        {% endif %}
      </table>
      {% else %}
      <div class="location-empty">No location history yet.</div>
      {% endif %}

      <!-- Import section -->
      <div class="import-section">
        <h3>Import from Google Takeout</h3>
        <p>
          Download your location history from
          <a href="https://takeout.google.com" target="_blank" rel="noopener">takeout.google.com</a>
          (select "Location History (Timeline)"), then upload a monthly JSON file from
          <code>Takeout/Location History (Timeline)/Semantic Location History/YYYY/YYYY_MONTH.json</code>.
        </p>
        <form id="import-form" class="import-form">
          <input type="file" id="import-file" accept=".json" required />
          <button type="submit" class="btn-import">üì• Import</button>
        </form>
        <div id="import-status" class="import-status" hidden></div>
      </div>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>&copy; 2026 James Massucco</p>
      </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
      import { insertThemeToggle } from "https://assets.jamesmassucco.com/scripts/theme-toggle.js?v=2.0";
      window.addEventListener("DOMContentLoaded", () => {
        insertThemeToggle();
      });
    </script>

    {% if all_locations %}
    <script>
      (function () {
        const locations = [
          {% for loc in all_locations %}
          {
            lat: {{ loc.latitude }},
            lon: {{ loc.longitude }},
            label:
              "{{ (loc.city or '') | replace('"', '\\"') }}{% if loc.city and loc.country %}, {% endif %}{{ (loc.country or '') | replace('"', '\\"') }}",
            date: "{{ loc.date.isoformat() }}",
            isToday: {{ 'true' if loc.date == today else 'false' }},
          },
          {% endfor %}
        ];

        const map = L.map("location-map");
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "¬© OpenStreetMap contributors",
        }).addTo(map);

        const bounds = [];
        locations.forEach((loc) => {
          const color = loc.isToday ? "#0070f3" : "#888";
          const marker = L.circleMarker([loc.lat, loc.lon], {
            radius: loc.isToday ? 10 : 7,
            fillColor: color,
            color: "#fff",
            weight: 2,
            opacity: 1,
            fillOpacity: 0.9,
          }).addTo(map);
          marker.bindPopup(
            `<strong>${loc.label || "Unknown"}</strong><br/>${loc.date}`,
          );
          bounds.push([loc.lat, loc.lon]);
        });

        if (bounds.length > 0) {
          map.fitBounds(bounds, { padding: [30, 30] });
        }
      })();
    </script>
    {% endif %}
    <script>
      document.getElementById("import-form")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById("import-file");
        const statusEl = document.getElementById("import-status");
        if (!fileInput.files || fileInput.files.length === 0) return;

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        if (statusEl) {
          statusEl.hidden = false;
          statusEl.textContent = "Importing‚Ä¶";
          statusEl.className = "import-status";
        }

        try {
          const res = await fetch("/location/api/import", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          if (res.ok) {
            if (statusEl) {
              statusEl.textContent = `‚úÖ Imported ${data.imported} location(s).`;
              statusEl.className = "import-status import-ok";
            }
            setTimeout(() => window.location.reload(), 1500);
          } else {
            if (statusEl) {
              statusEl.textContent = "‚ùå Import failed: " + (data.detail || res.status);
              statusEl.className = "import-status import-error";
            }
          }
        } catch (err) {
          if (statusEl) {
            statusEl.textContent = "‚ùå Import failed: " + err;
            statusEl.className = "import-status import-error";
          }
        }
      });
    </script>
  </body>
</html>
