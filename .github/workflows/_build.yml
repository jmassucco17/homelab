name: Build Images (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to build for (prod or staging)'
        required: false
        type: string
        default: 'prod'
    outputs:
      shared-assets-changed:
        description: 'Whether shared-assets image changed'
        value: ${{ jobs.build-shared-assets.outputs.changed }}
      homepage-changed:
        description: 'Whether homepage image changed'
        value: ${{ jobs.build-homepage.outputs.changed }}
      blog-changed:
        description: 'Whether blog image changed'
        value: ${{ jobs.build-blog.outputs.changed }}
      games-changed:
        description: 'Whether games image changed'
        value: ${{ jobs.build-games.outputs.changed }}
      tools-changed:
        description: 'Whether tools image changed'
        value: ${{ jobs.build-tools.outputs.changed }}
      travel-changed:
        description: 'Whether travel image changed'
        value: ${{ jobs.build-travel.outputs.changed }}

jobs:
  build-base:
    name: build python-base
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Docker and login
        uses: ./.github/actions/docker-setup

      - name: Build and push python-base
        uses: ./.github/actions/docker-build-push
        with:
          image: ghcr.io/jmassucco17/homelab/python-base
          context: .
          dockerfile: python-base/Dockerfile
          cache-scope: python-base

  build-shared-assets:
    name: build shared-assets
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.build.outputs.changed }}
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
      - name: Setup Docker and login
        uses: ./.github/actions/docker-setup
      - name: Build and push shared-assets
        id: build
        uses: ./.github/actions/docker-build-push
        with:
          image: ghcr.io/jmassucco17/homelab/shared-assets
          context: shared-assets
          dockerfile: shared-assets/Dockerfile
          cache-scope: shared-assets

  build-homepage:
    name: build homepage
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.build.outputs.changed }}
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
      - name: Setup Docker and login
        uses: ./.github/actions/docker-setup
      - name: Build and push homepage
        id: build
        uses: ./.github/actions/docker-build-push
        with:
          image: ghcr.io/jmassucco17/homelab/homepage
          context: homepage
          dockerfile: homepage/Dockerfile
          cache-scope: homepage

  build-blog:
    name: build blog
    needs: build-base
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.build.outputs.changed }}
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
      - name: Setup Docker and login
        uses: ./.github/actions/docker-setup
      - name: Build and push blog
        id: build
        uses: ./.github/actions/docker-build-push
        with:
          image: ghcr.io/jmassucco17/homelab/blog
          context: .
          dockerfile: blog/Dockerfile
          cache-scope: blog

  build-games:
    name: build games
    needs: build-base
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.build.outputs.changed }}
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
      - name: Setup Docker and login
        uses: ./.github/actions/docker-setup
      - name: Build and push games
        id: build
        uses: ./.github/actions/docker-build-push
        with:
          image: ghcr.io/jmassucco17/homelab/games
          context: .
          dockerfile: games/Dockerfile
          cache-scope: games

  build-tools:
    name: build tools
    needs: build-base
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.build.outputs.changed }}
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
      - name: Setup Docker and login
        uses: ./.github/actions/docker-setup
      - name: Build and push tools
        id: build
        uses: ./.github/actions/docker-build-push
        with:
          image: ghcr.io/jmassucco17/homelab/tools
          context: .
          dockerfile: tools/Dockerfile
          cache-scope: tools

  build-travel:
    name: build travel
    needs: build-base
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.build.outputs.changed }}
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
      - name: Setup Docker and login
        uses: ./.github/actions/docker-setup
      - name: Build and push travel
        id: build
        uses: ./.github/actions/docker-build-push
        with:
          image: ghcr.io/jmassucco17/homelab/travel
          context: .
          dockerfile: travel/Dockerfile
          cache-scope: travel
