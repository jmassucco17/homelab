name: Build Python Images (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to build for (prod or staging)'
        required: false
        type: string
        default: 'prod'
      blog:
        description: 'Build blog'
        type: boolean
        default: true
      travel:
        description: 'Build travel'
        type: boolean
        default: true
      games:
        description: 'Build games'
        type: boolean
        default: true
      tools:
        description: 'Build tools'
        type: boolean
        default: true

jobs:
  build-base:
    name: build python-base
    # Only build python-base if at least one Python service is enabled
    if: inputs.blog || inputs.games || inputs.tools || inputs.travel
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Docker and login
        uses: ./.github/actions/docker-setup

      - name: Build and push python-base
        uses: ./.github/actions/docker-build-push
        with:
          image: ghcr.io/jmassucco17/homelab/python-base
          context: .
          dockerfile: python-base/Dockerfile
          cache-scope: python-base

  build-blog:
    name: build blog
    needs: build-base
    if: |
      !cancelled() &&
      (needs.build-base.result == 'success' || needs.build-base.result == 'skipped') &&
      inputs.blog
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
      - name: Setup Docker and login
        uses: ./.github/actions/docker-setup
      - name: Build and push blog
        uses: ./.github/actions/docker-build-push
        with:
          image: ghcr.io/jmassucco17/homelab/blog
          context: .
          dockerfile: blog/Dockerfile
          cache-scope: blog

  build-games:
    name: build games
    needs: build-base
    if: |
      !cancelled() &&
      (needs.build-base.result == 'success' || needs.build-base.result == 'skipped') &&
      inputs.games
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
      - name: Setup Docker and login
        uses: ./.github/actions/docker-setup
      - name: Build and push games
        uses: ./.github/actions/docker-build-push
        with:
          image: ghcr.io/jmassucco17/homelab/games
          context: .
          dockerfile: games/Dockerfile
          cache-scope: games

  build-tools:
    name: build tools
    needs: build-base
    if: |
      !cancelled() &&
      (needs.build-base.result == 'success' || needs.build-base.result == 'skipped') &&
      inputs.tools
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
      - name: Setup Docker and login
        uses: ./.github/actions/docker-setup
      - name: Build and push tools
        uses: ./.github/actions/docker-build-push
        with:
          image: ghcr.io/jmassucco17/homelab/tools
          context: .
          dockerfile: tools/Dockerfile
          cache-scope: tools

  build-travel:
    name: build travel
    needs: build-base
    if: |
      !cancelled() &&
      (needs.build-base.result == 'success' || needs.build-base.result == 'skipped') &&
      inputs.travel
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
      - name: Setup Docker and login
        uses: ./.github/actions/docker-setup
      - name: Build and push travel
        uses: ./.github/actions/docker-build-push
        with:
          image: ghcr.io/jmassucco17/homelab/travel
          context: .
          dockerfile: travel/Dockerfile
          cache-scope: travel
