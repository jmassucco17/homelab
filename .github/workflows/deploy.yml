name: Deploy

on:
  workflow_dispatch:
    inputs:
      networking:
        description: 'Deploy networking'
        type: boolean
        default: true
      shared-assets:
        description: 'Deploy shared-assets'
        type: boolean
        default: true
      homepage:
        description: 'Deploy homepage'
        type: boolean
        default: true
      blog:
        description: 'Deploy blog'
        type: boolean
        default: true
      travel:
        description: 'Deploy travel'
        type: boolean
        default: true
      games:
        description: 'Deploy games'
        type: boolean
        default: true
      tools:
        description: 'Deploy tools'
        type: boolean
        default: true
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:github

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null

      - name: Create deployment archive
        run: |
          grep -v '^#' .gitignore | grep -v '^$' > /tmp/exclude_list
          printf '.git/\n*.tar.gz\n*.tar\n' >> /tmp/exclude_list
          tar --exclude-from=/tmp/exclude_list -cf /tmp/homelab-deploy.tar .
          gzip /tmp/homelab-deploy.tar

      - name: Upload archive to server
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            /tmp/homelab-deploy.tar.gz \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/homelab-deploy.tar.gz"

      - name: Extract and start services on server
        env:
          # On push, deploy all services; on workflow_dispatch, deploy only checked ones
          DEPLOY_NETWORKING: ${{ github.event_name == 'push' || inputs.networking }}
          DEPLOY_SHARED_ASSETS: ${{ github.event_name == 'push' || inputs['shared-assets'] }}
          DEPLOY_HOMEPAGE: ${{ github.event_name == 'push' || inputs.homepage }}
          DEPLOY_BLOG: ${{ github.event_name == 'push' || inputs.blog }}
          DEPLOY_TRAVEL: ${{ github.event_name == 'push' || inputs.travel }}
          DEPLOY_GAMES: ${{ github.event_name == 'push' || inputs.games }}
          DEPLOY_TOOLS: ${{ github.event_name == 'push' || inputs.tools }}
          # Networking secrets (passed to docker compose on the server)
          CLOUDFLARE_API_EMAIL: ${{ secrets.CLOUDFLARE_API_EMAIL }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_TRUSTED_IPS: ${{ secrets.CLOUDFLARE_TRUSTED_IPS }}
          GOOGLE_OAUTH2_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH2_CLIENT_ID }}
          GOOGLE_OAUTH2_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH2_CLIENT_SECRET }}
          GOOGLE_OAUTH2_COOKIE_SECRET: ${{ secrets.GOOGLE_OAUTH2_COOKIE_SECRET }}
          OAUTH2_AUTHORIZED_EMAILS: ${{ secrets.OAUTH2_AUTHORIZED_EMAILS }}
          # Tools secret
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" \
            env \
              DEPLOY_NETWORKING="${DEPLOY_NETWORKING}" \
              DEPLOY_SHARED_ASSETS="${DEPLOY_SHARED_ASSETS}" \
              DEPLOY_HOMEPAGE="${DEPLOY_HOMEPAGE}" \
              DEPLOY_BLOG="${DEPLOY_BLOG}" \
              DEPLOY_TRAVEL="${DEPLOY_TRAVEL}" \
              DEPLOY_GAMES="${DEPLOY_GAMES}" \
              DEPLOY_TOOLS="${DEPLOY_TOOLS}" \
              CLOUDFLARE_API_EMAIL="${CLOUDFLARE_API_EMAIL}" \
              CLOUDFLARE_API_TOKEN="${CLOUDFLARE_API_TOKEN}" \
              CLOUDFLARE_TRUSTED_IPS="${CLOUDFLARE_TRUSTED_IPS}" \
              GOOGLE_OAUTH2_CLIENT_ID="${GOOGLE_OAUTH2_CLIENT_ID}" \
              GOOGLE_OAUTH2_CLIENT_SECRET="${GOOGLE_OAUTH2_CLIENT_SECRET}" \
              GOOGLE_OAUTH2_COOKIE_SECRET="${GOOGLE_OAUTH2_COOKIE_SECRET}" \
              OAUTH2_AUTHORIZED_EMAILS="${OAUTH2_AUTHORIZED_EMAILS}" \
              TMDB_API_KEY="${TMDB_API_KEY}" \
            bash -s << 'REMOTE'
          set -euo pipefail
          mkdir -p /opt/homelab
          cd /opt/homelab
          echo "Extracting deployment archive..."
          tar -xzf /tmp/homelab-deploy.tar.gz
          touch networking/acme.json
          chmod 600 networking/acme.json
          docker network create web 2>/dev/null || true

          # Deploy each service if its flag is true
          deploy_if_enabled() {
            local svc="$1"
            local flag="$2"
            if [ "$flag" = "true" ]; then
              echo "--- Starting $svc ---"
              /opt/homelab/scripts/start_service.sh "$svc"
            else
              echo "--- Skipping $svc ---"
            fi
          }

          # Services deployed in dependency order
          deploy_if_enabled networking      "$DEPLOY_NETWORKING"
          deploy_if_enabled shared-assets   "$DEPLOY_SHARED_ASSETS"
          deploy_if_enabled homepage        "$DEPLOY_HOMEPAGE"
          deploy_if_enabled blog            "$DEPLOY_BLOG"
          deploy_if_enabled travel          "$DEPLOY_TRAVEL"
          deploy_if_enabled games           "$DEPLOY_GAMES"
          deploy_if_enabled tools           "$DEPLOY_TOOLS"

          rm -f /tmp/homelab-deploy.tar.gz
          echo "Deployment complete."
          REMOTE
