name: Docker integration tests

on:
  workflow_dispatch:
  workflow_call:

jobs:
  compose-validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Create networking/.env stub
        run: |
          cat > networking/.env <<'EOF'
          CLOUDFLARE_API_EMAIL=test@example.com
          CLOUDFLARE_API_TOKEN=test-token
          CLOUDFLARE_TRUSTED_IPS=0.0.0.0/0
          GOOGLE_OAUTH2_CLIENT_ID=test-client-id
          GOOGLE_OAUTH2_CLIENT_SECRET=test-client-secret
          GOOGLE_OAUTH2_COOKIE_SECRET=00000000000000000000000000000000
          OAUTH2_AUTHORIZED_EMAILS=test@example.com
          EOF

      - name: Create monitoring/.env stub
        run: |
          cat > monitoring/.env <<'EOF'
          GRAFANA_CLOUD_PROM_URL=https://prometheus.example.com/api/prom/push
          GRAFANA_CLOUD_PROM_USER=123456
          GRAFANA_CLOUD_LOKI_URL=https://loki.example.com/loki/api/v1/push
          GRAFANA_CLOUD_LOKI_USER=123456
          GRAFANA_CLOUD_API_KEY=test-api-key
          EOF

      - name: Validate all Compose files
        run: |
          for dir in networking monitoring shared-assets homepage blog games portainer tools travel; do
            echo "--- Validating $dir ---"

            # Validate base compose file
            echo "  Base: $dir/docker-compose.yml"
            docker compose -f "$dir/docker-compose.yml" config --quiet

            # Validate prod overlay if it exists
            if [ -f "$dir/docker-compose.prod.yml" ]; then
              echo "  Prod: $dir/docker-compose.yml + $dir/docker-compose.prod.yml"
              docker compose -f "$dir/docker-compose.yml" -f "$dir/docker-compose.prod.yml" config --quiet
            fi

            # Validate staging overlay if it exists
            if [ -f "$dir/docker-compose.staging.yml" ]; then
              echo "  Staging: $dir/docker-compose.yml + $dir/docker-compose.staging.yml"
              docker compose -f "$dir/docker-compose.yml" -f "$dir/docker-compose.staging.yml" config --quiet
            fi
          done

  networking:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Create networking/.env with test credentials
        run: |
          COOKIE_SECRET=$(python3 -c "import secrets; print(secrets.token_hex(16))")
          cat > networking/.env << EOF
          CLOUDFLARE_API_EMAIL=test@example.com
          CLOUDFLARE_API_TOKEN=test-token
          CLOUDFLARE_TRUSTED_IPS=0.0.0.0/0
          GOOGLE_OAUTH2_CLIENT_ID=test-client-id
          GOOGLE_OAUTH2_CLIENT_SECRET=test-client-secret
          GOOGLE_OAUTH2_COOKIE_SECRET=${COOKIE_SECRET}
          OAUTH2_AUTHORIZED_EMAILS=test@example.com
          EOF

      - name: Create acme.json with correct permissions
        run: |
          touch networking/acme.json
          chmod 600 networking/acme.json

      - name: Create docker web network
        run: docker network create web 2>/dev/null || true

      - name: Create docker internal_metrics network
        run: docker network create internal_metrics 2>/dev/null || true

      - name: Pull cloudflare-ddns image (validates tag exists)
        run: |
          cd networking
          docker compose pull cloudflare-ddns

      - name: Start networking services (excluding cloudflare-ddns)
        run: |
          cd networking
          docker compose up -d --wait traefik oauth2-proxy whoami

      - name: Test traefik ping endpoint
        run: docker exec traefik wget -qO- http://127.0.0.1:8080/ping

      - name: Test oauth2-proxy is listening
        run: |
          PROXY_IP=$(docker inspect oauth2-proxy --format='{{.NetworkSettings.Networks.web.IPAddress}}')
          docker run --rm --network web alpine wget -qO- "http://${PROXY_IP}:4180/ping"

      - name: Test whoami is responding
        run: |
          WHOAMI_IP=$(docker inspect whoami --format='{{.NetworkSettings.Networks.web.IPAddress}}')
          docker run --rm --network web alpine wget -qO- "http://${WHOAMI_IP}/"

      - name: Stop networking services
        uses: ./.github/actions/stop-service
        if: always()
        with:
          service: networking

  shared-assets:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Start shared-assets service
        uses: ./.github/actions/start-service
        with:
          service: shared-assets
          build: 'true'

      - name: Test CSS file is served
        run: |
          result=$(docker exec shared-assets wget -qO- http://127.0.0.1/styles/main.css)
          echo "$result" | grep -q '@import'

      - name: Test JS file is served
        run: |
          result=$(docker exec shared-assets wget -qO- http://127.0.0.1/scripts/theme-toggle.js)
          echo "$result" | grep -q 'function'

      - name: Test missing file returns 404
        run: |
          docker exec shared-assets wget -qO- http://127.0.0.1/nonexistent.txt 2>&1 | grep -q '404'

      - name: Stop shared-assets service
        uses: ./.github/actions/stop-service
        if: always()
        with:
          service: shared-assets

  homepage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Start homepage service
        uses: ./.github/actions/start-service
        with:
          service: homepage
          build: 'true'

      - name: Test index endpoint returns HTML
        run: |
          result=$(docker exec homepage wget -qO- http://127.0.0.1/)
          echo "$result" | grep -qi '<html'

      - name: Stop homepage service
        uses: ./.github/actions/stop-service
        if: always()
        with:
          service: homepage

  blog:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Start blog service
        uses: ./.github/actions/start-service
        with:
          service: blog
          build: 'true'

      - name: Test health endpoint
        uses: ./.github/actions/test-health-endpoint
        with:
          service: blog

      - name: Stop blog service
        uses: ./.github/actions/stop-service
        if: always()
        with:
          service: blog

  travel:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Start travel service
        uses: ./.github/actions/start-service
        with:
          service: travel
          build: 'true'

      - name: Test health endpoint
        uses: ./.github/actions/test-health-endpoint
        with:
          service: travel

      - name: Stop travel service
        uses: ./.github/actions/stop-service
        if: always()
        with:
          service: travel

  games:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Start games service
        uses: ./.github/actions/start-service
        with:
          service: games
          build: 'true'

      - name: Test health endpoint
        uses: ./.github/actions/test-health-endpoint
        with:
          service: games

      - name: Stop games service
        uses: ./.github/actions/stop-service
        if: always()
        with:
          service: games

  tools:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Start tools service
        uses: ./.github/actions/start-service
        with:
          service: tools
          build: 'true'

      - name: Test health endpoint
        uses: ./.github/actions/test-health-endpoint
        with:
          service: tools

      - name: Stop tools service
        uses: ./.github/actions/stop-service
        if: always()
        with:
          service: tools

  portainer:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Create docker web network
        run: docker network create web 2>/dev/null || true

      - name: Pull and start portainer
        run: |
          cd portainer
          docker compose up -d

      - name: Wait for portainer API to be ready
        run: |
          PORTAINER_IP=$(docker inspect portainer --format='{{.NetworkSettings.Networks.web.IPAddress}}')
          for i in $(seq 1 12); do
            if docker run --rm --network web alpine wget -qO- "http://${PORTAINER_IP}:9000/api/system/status" 2>/dev/null; then
              echo "Portainer is ready"
              exit 0
            fi
            echo "Attempt ${i}/12: portainer not ready yet, waiting 5s..."
            sleep 5
          done
          echo "Portainer did not become ready in time"
          exit 1

      - name: Stop portainer service
        if: always()
        run: |
          cd portainer
          docker compose down --remove-orphans

  monitoring:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Create monitoring/.env stub
        run: |
          cat > monitoring/.env <<'EOF'
          GRAFANA_CLOUD_PROM_URL=https://prometheus.example.com/api/prom/push
          GRAFANA_CLOUD_PROM_USER=123456
          GRAFANA_CLOUD_LOKI_URL=https://loki.example.com/loki/api/v1/push
          GRAFANA_CLOUD_LOKI_USER=123456
          GRAFANA_CLOUD_API_KEY=test-api-key
          EOF

      - name: Create internal_metrics Docker network
        run: docker network create internal_metrics 2>/dev/null || true

      - name: Start node-exporter and cadvisor
        run: |
          cd monitoring
          docker compose up -d --wait node-exporter cadvisor

      - name: Test node-exporter serves metrics
        run: |
          docker run --rm --network internal_metrics alpine \
            wget -qO- http://node-exporter:9100/metrics | grep -q 'node_'

      - name: Test cadvisor serves metrics
        run: |
          docker run --rm --network internal_metrics alpine \
            wget -qO- http://cadvisor:8080/metrics | grep -q 'container_'

      - name: Stop monitoring services
        if: always()
        run: |
          cd monitoring
          docker compose down --remove-orphans
