services:
  # Reverse-proxy service
  traefik:
    image: traefik:v3.6
    container_name: traefik
    ports:
      - '443:443'
      # Expose metrics
      # - '8082:8082'
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock:ro'
      # Ensure this file has 600 permissions
      - './acme.json:/letsencrypt/acme.json'
      - './traefik.yml:/etc/traefik/traefik.yml:ro'
      - './config:/etc/traefik/config:ro'
    networks:
      - web
    env_file:
      - .env
    environment:
      - CF_DNS_API_TOKEN=${CLOUDFLARE_API_TOKEN}
      # Traefik env-var override: trustedIPs is a list type and cannot be expanded
      # from a comma-separated env var inside traefik.yml, so we use the TRAEFIK_
      # env var naming convention instead (comma-separated values are accepted).
      - TRAEFIK_ENTRYPOINTS_WEBSECURE_FORWARDEDHEADERS_TRUSTEDIPS=${CLOUDFLARE_TRUSTED_IPS}
      - TRAEFIK_ENTRYPOINTS_WEBSECURE_FORWARDEDHEADERS_INSECURE=true
    healthcheck:
      test: ['CMD', 'wget', '-qO-', 'http://127.0.0.1:8080/ping']
      interval: 5s
      timeout: 1s
      retries: 3
      start_period: 3s
    restart: unless-stopped

  # Provide Google OAuth services for other containers
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    container_name: oauth2-proxy
    command:
      - --cookie-domain=.jamesmassucco.com
    environment:
      # Provider (Google) settings
      OAUTH2_PROXY_PROVIDER: google
      OAUTH2_PROXY_CLIENT_ID: ${GOOGLE_OAUTH2_CLIENT_ID}
      OAUTH2_PROXY_CLIENT_SECRET: ${GOOGLE_OAUTH2_CLIENT_SECRET}
      OAUTH2_PROXY_EMAIL_DOMAINS: '*'
      OAUTH2_PROXY_AUTHENTICATED_EMAILS: ${OAUTH2_AUTHORIZED_EMAILS}
      OAUTH2_PROXY_REDIRECT_URL: https://oauth.jamesmassucco.com/oauth2/callback
      # Cookie / session settings
      OAUTH2_PROXY_COOKIE_SECRET: ${GOOGLE_OAUTH2_COOKIE_SECRET}
      OAUTH2_PROXY_COOKIE_DOMAIN: .jamesmassucco.com
      OAUTH2_PROXY_COOKIE_SECURE: true
      OAUTH2_PROXY_COOKIE_SAMESITE: lax
      # Login flow
      OAUTH2_PROXY_SIGN_IN_PAGE: auto
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: true
      OAUTH2_PROXY_WHITELIST_DOMAINS: .jamesmassucco.com
      # Headers and forwarding
      OAUTH2_PROXY_SET_XAUTHREQUEST: true
      OAUTH2_PROXY_REVERSE_PROXY: true
      # Networking
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
      # Upstream target
      OAUTH2_PROXY_UPSTREAMS: static://200
      # Logging
      OAUTH2_PROXY_SHOW_DEBUG_ON_ERROR: true
      # OAUTH2_PROXY_LOG_LEVEL: debug
    networks:
      - web
    labels:
      - traefik.enable=true
    restart: unless-stopped

  # Basic whoami service, useful for debugging network configuration
  whoami:
    image: traefik/whoami:v1.11
    container_name: whoami
    networks:
      - web
    labels:
      - traefik.enable=true
    restart: unless-stopped

  # Automatically updates public IP DNS in Cloudflare
  cloudflare-ddns:
    image: favonia/cloudflare-ddns:1.15.1
    container_name: cloudflare-ddns
    network_mode: host
    read_only: true
    security_opt:
      - no-new-privileges:true
    environment:
      CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN}
      DOMAINS: >
        jamesmassucco.com,
        staging.jamesmassucco.com,
        dashboard.jamesmassucco.com,
        blog.jamesmassucco.com,
        oauth.jamesmassucco.com,
        assets.jamesmassucco.com,
        traefik.jamesmassucco.com,
        whoami.jamesmassucco.com,
        travel.jamesmassucco.com,
        games.jamesmassucco.com,
        tools.jamesmassucco.com,
      PROXIED: true
      TZ: America/Los_Angeles
    restart: unless-stopped

networks:
  web:
    external: true
