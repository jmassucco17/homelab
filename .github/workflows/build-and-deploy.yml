name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - prod
          - staging
        default: 'prod'
      seed_from_prod:
        description: '[staging only] Seed data from production volume'
        type: boolean
        default: false
      networking:
        description: 'Deploy networking'
        type: boolean
        default: true
      shared-assets:
        description: 'Deploy shared-assets'
        type: boolean
        default: true
      homepage:
        description: 'Deploy homepage'
        type: boolean
        default: true
      blog:
        description: 'Deploy blog'
        type: boolean
        default: true
      travel:
        description: 'Deploy travel'
        type: boolean
        default: true
      games:
        description: 'Deploy games'
        type: boolean
        default: true
      tools:
        description: 'Deploy tools'
        type: boolean
        default: true
      monitoring:
        description: 'Deploy monitoring'
        type: boolean
        default: true
      portainer:
        description: 'Deploy portainer'
        type: boolean
        default: true

jobs:
  # Determine environment based on trigger and inputs
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.determine-env.outputs.environment }}
      image_tag: ${{ steps.image-tag.outputs.tag }}
      networking_changed: ${{ steps.check-changes.outputs.networking }}
      portainer_changed: ${{ steps.check-changes.outputs.portainer }}
      monitoring_changed: ${{ steps.check-changes.outputs.monitoring }}
      homepage_changed: ${{ steps.check-changes.outputs.homepage }}
      shared-assets_changed: ${{ steps.check-changes.outputs.shared-assets }}
      blog_changed: ${{ steps.check-changes.outputs.blog }}
      travel_changed: ${{ steps.check-changes.outputs.travel }}
      games_changed: ${{ steps.check-changes.outputs.games }}
      tools_changed: ${{ steps.check-changes.outputs.tools }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Determine environment
        id: determine-env
        # If the workflow is triggered by a push (to main), it's prod;
        # otherwise, use the input
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "Environment determined from push event: prod"
            echo "environment=prod" >> "$GITHUB_OUTPUT"
          else
            echo "Environment determined from workflow_dispatch input: ${{ inputs.environment }}"
            echo "environment=${{ inputs.environment }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Set image tag
        id: image-tag
        run: |
          if [ "${{ steps.determine-env.outputs.environment }}" = "staging" ]; then
            echo "tag=sha-$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          else
            echo "tag=latest" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for changes
        id: check-changes
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "=== Checking for module changes ==="
            for module in networking portainer monitoring homepage shared-assets; do
              changed_files=$(git diff --name-only HEAD^ HEAD | grep "^${module}/" || true)
              if [ -n "$changed_files" ]; then
                echo "✓ ${module}: CHANGED"
                echo "  Files:"
                while IFS= read -r file; do
                  echo "    - $file"
                done <<< "$changed_files"
                echo "${module}=true" >> "$GITHUB_OUTPUT"
              else
                echo "✗ ${module}: no changes"
                echo "${module}=false" >> "$GITHUB_OUTPUT"
              fi
            done
            python_base_changed=$(git diff --name-only HEAD^ HEAD \
              | grep -E "^(requirements\.txt|python-base/)" || true)
            if [ -n "$python_base_changed" ]; then
              echo "✓ python-base / requirements.txt: CHANGED (affects all Python apps)"
            fi
            for module in blog travel games tools; do
              app_changed=$(git diff --name-only HEAD^ HEAD | grep "^${module}/" || true)
              if [ -n "$app_changed" ] || [ -n "$python_base_changed" ]; then
                echo "✓ ${module}: CHANGED"
                echo "${module}=true" >> "$GITHUB_OUTPUT"
              else
                echo "✗ ${module}: no changes"
                echo "${module}=false" >> "$GITHUB_OUTPUT"
              fi
            done
          else
            echo "=== Manual workflow trigger - all modules enabled ==="
            # For manual triggers, respect the input
            for module in networking portainer monitoring homepage shared-assets blog travel games tools; do
              echo "✓ ${module}: enabled (manual trigger)"
              echo "${module}=true" >> "$GITHUB_OUTPUT"
            done
          fi

  # Prepare server by uploading archive containing the docker-compose files,
  # deployment scripts, and secrets as .env files
  prep-server:
    needs: setup
    permissions:
      contents: read
    uses: ./.github/workflows/_prep-server.yml
    secrets: inherit
    with:
      environment: ${{ needs.setup.outputs.environment }}
      seed_from_prod: ${{ github.event_name == 'workflow_dispatch' && inputs.seed_from_prod || false }}

  # Build simple (nginx-based) services
  build-simple:
    needs: setup
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/_build-simple.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
      shared-assets: ${{ (github.event_name == 'push' && needs.setup.outputs.shared-assets_changed == 'true') || (github.event_name == 'workflow_dispatch' && inputs['shared-assets']) }}
      homepage: ${{ (github.event_name == 'push' && needs.setup.outputs.homepage_changed == 'true') || (github.event_name == 'workflow_dispatch' && inputs.homepage) }}

  # Build Python images
  build-python:
    needs: setup
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/_build-python.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
      blog: ${{ (github.event_name == 'push' && needs.setup.outputs.blog_changed == 'true') || (github.event_name == 'workflow_dispatch' && inputs.blog) }}
      travel: ${{ (github.event_name == 'push' && needs.setup.outputs.travel_changed == 'true') || (github.event_name == 'workflow_dispatch' && inputs.travel) }}
      games: ${{ (github.event_name == 'push' && needs.setup.outputs.games_changed == 'true') || (github.event_name == 'workflow_dispatch' && inputs.games) }}
      tools: ${{ (github.event_name == 'push' && needs.setup.outputs.tools_changed == 'true') || (github.event_name == 'workflow_dispatch' && inputs.tools) }}

  # Deploy off-the-shelf (OTS) services in parallel with build
  # These use Docker Hub images (nginx, grafana, etc.) and don't need any build
  deploy-ots:
    needs: [setup, prep-server]
    permissions:
      contents: read
    uses: ./.github/workflows/_deploy-ots.yml
    secrets: inherit
    with:
      environment: ${{ needs.setup.outputs.environment }}
      networking: ${{ (github.event_name == 'push' && needs.setup.outputs.networking_changed == 'true') || (github.event_name == 'workflow_dispatch' && inputs.networking) }}
      monitoring: ${{ (github.event_name == 'push' && needs.setup.outputs.monitoring_changed == 'true') || (github.event_name == 'workflow_dispatch' && inputs.monitoring) }}
      portainer: ${{ (github.event_name == 'push' && needs.setup.outputs.portainer_changed == 'true') || (github.event_name == 'workflow_dispatch' && inputs.portainer) }}

  # Deploy simple nginx-based services after their builds complete
  # These only depend on nginx base image (no python-base dependency)
  deploy-simple:
    needs: [setup, prep-server, build-simple]
    permissions:
      contents: read
    uses: ./.github/workflows/_deploy-simple.yml
    secrets: inherit
    with:
      environment: ${{ needs.setup.outputs.environment }}
      staging_image_tag: ${{ needs.setup.outputs.image_tag }}
      shared-assets: ${{ github.event_name == 'push' || inputs['shared-assets'] }}
      homepage: ${{ github.event_name == 'push' || inputs.homepage }}

  # Deploy Python-based services after build completes
  # These depend on python-base image being built first
  deploy-python:
    needs: [setup, prep-server, build-python]
    permissions:
      contents: read
    uses: ./.github/workflows/_deploy-python.yml
    secrets: inherit
    with:
      environment: ${{ needs.setup.outputs.environment }}
      staging_image_tag: ${{ needs.setup.outputs.image_tag }}
      blog: ${{ (github.event_name == 'push' && needs.setup.outputs.blog_changed == 'true') || (github.event_name == 'workflow_dispatch' && inputs.blog) }}
      travel: ${{ (github.event_name == 'push' && needs.setup.outputs.travel_changed == 'true') || (github.event_name == 'workflow_dispatch' && inputs.travel) }}
      games: ${{ (github.event_name == 'push' && needs.setup.outputs.games_changed == 'true') || (github.event_name == 'workflow_dispatch' && inputs.games) }}
      tools: ${{ (github.event_name == 'push' && needs.setup.outputs.tools_changed == 'true') || (github.event_name == 'workflow_dispatch' && inputs.tools) }}
