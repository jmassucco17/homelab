name: Deploy

on:
  workflow_dispatch:
    inputs:
      networking:
        description: 'Deploy networking'
        type: boolean
        default: true
      shared-assets:
        description: 'Deploy shared-assets'
        type: boolean
        default: true
      homepage:
        description: 'Deploy homepage'
        type: boolean
        default: true
      blog:
        description: 'Deploy blog'
        type: boolean
        default: true
      travel:
        description: 'Deploy travel'
        type: boolean
        default: true
      games:
        description: 'Deploy games'
        type: boolean
        default: true
      tools:
        description: 'Deploy tools'
        type: boolean
        default: true
  workflow_call:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:github

      - name: Write networking/.env from secret
        run: printf '%s' "${{ secrets.NETWORKING_ENV }}" > networking/.env

      - name: Write tools/.env from secret
        run: printf 'TMDB_API_KEY=%s\n' "${{ secrets.TMDB_API_KEY }}" > tools/.env

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null

      - name: Transfer config files to server
        run: |
          mkdir -p /tmp/homelab-config/networking
          cp networking/docker-compose.yml /tmp/homelab-config/networking/
          cp networking/.env /tmp/homelab-config/networking/
          for svc in shared-assets homepage blog travel games tools; do
            mkdir -p "/tmp/homelab-config/$svc"
            cp "$svc/docker-compose.yml" "/tmp/homelab-config/$svc/"
          done
          tar -czf /tmp/homelab-config.tar.gz -C /tmp/homelab-config .
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            /tmp/homelab-config.tar.gz \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/homelab-config.tar.gz"

      - name: Deploy services on server
        env:
          # On workflow_call (automatic), inputs are empty so || true deploys all services.
          # On workflow_dispatch (manual), inputs reflect the user's checkbox selections.
          DEPLOY_NETWORKING: ${{ inputs.networking || true }}
          DEPLOY_SHARED_ASSETS: ${{ inputs['shared-assets'] || true }}
          DEPLOY_HOMEPAGE: ${{ inputs.homepage || true }}
          DEPLOY_BLOG: ${{ inputs.blog || true }}
          DEPLOY_TRAVEL: ${{ inputs.travel || true }}
          DEPLOY_GAMES: ${{ inputs.games || true }}
          DEPLOY_TOOLS: ${{ inputs.tools || true }}
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" \
            "DEPLOY_NETWORKING='${DEPLOY_NETWORKING}' DEPLOY_SHARED_ASSETS='${DEPLOY_SHARED_ASSETS}' DEPLOY_HOMEPAGE='${DEPLOY_HOMEPAGE}' DEPLOY_BLOG='${DEPLOY_BLOG}' DEPLOY_TRAVEL='${DEPLOY_TRAVEL}' DEPLOY_GAMES='${DEPLOY_GAMES}' DEPLOY_TOOLS='${DEPLOY_TOOLS}' bash -s" << 'REMOTE'
          set -euo pipefail
          mkdir -p /opt/homelab
          cd /opt/homelab
          echo "Extracting config files..."
          tar -xzf /tmp/homelab-config.tar.gz
          touch networking/acme.json
          chmod 600 networking/acme.json
          docker network create web 2>/dev/null || true

          deploy_if_enabled() {
            local svc="$1"
            local flag="$2"
            if [ "$flag" = "true" ]; then
              echo "--- Deploying $svc ---"
              cd "/opt/homelab/$svc"
              docker compose pull
              docker compose up -d --wait
              cd /opt/homelab
            else
              echo "--- Skipping $svc ---"
            fi
          }

          # Deploy each service if its flag is true, in dependency order
          deploy_if_enabled networking      "$DEPLOY_NETWORKING"
          deploy_if_enabled shared-assets   "$DEPLOY_SHARED_ASSETS"
          deploy_if_enabled homepage        "$DEPLOY_HOMEPAGE"
          deploy_if_enabled blog            "$DEPLOY_BLOG"
          deploy_if_enabled travel          "$DEPLOY_TRAVEL"
          deploy_if_enabled games           "$DEPLOY_GAMES"
          deploy_if_enabled tools           "$DEPLOY_TOOLS"

          rm -f /tmp/homelab-config.tar.gz
          echo "Deployment complete."
          REMOTE
