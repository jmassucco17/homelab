name: Deploy Python Services (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to (`prod` or `staging`)'
        required: true
        type: string
      blog:
        description: 'Deploy blog'
        type: boolean
        default: true
      travel:
        description: 'Deploy travel'
        type: boolean
        default: true
      games:
        description: 'Deploy games'
        type: boolean
        default: true
      tools:
        description: 'Deploy tools'
        type: boolean
        default: true

jobs:
  # Deploy all Python-based services in parallel
  deploy-blog:
    name: deploy blog
    needs: setup
    if: inputs.blog
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:github
      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_SSH_HOST_KEY: ${{ secrets.SERVER_SSH_HOST_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          printf '%s\n' "$SERVER_SSH_HOST_KEY" >> ~/.ssh/known_hosts
      - name: Deploy blog
        env:
          SERVER_USER: ${{ vars.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          ENVIRONMENT: ${{ inputs.environment }}
          STAGING_IMAGE_TAG: ${{ needs.setup.outputs.image-tag }}
        run: |
          ssh -i ~/.ssh/deploy_key \
            "${SERVER_USER}@${SERVER_HOST}" \
            "cd /opt/homelab && ENVIRONMENT='${ENVIRONMENT}' STAGING_IMAGE_TAG='${STAGING_IMAGE_TAG}' bash -s" << 'REMOTE'
          set -euo pipefail
          if [ "${ENVIRONMENT}" = "staging" ]; then
            echo "--- Starting staging blog ---"
            STAGING_IMAGE_TAG="${STAGING_IMAGE_TAG}" /opt/homelab/scripts/start_service.sh blog --staging
          else
            echo "--- Deploying blog ---"
            /opt/homelab/scripts/start_service.sh blog
          fi
          REMOTE

  deploy-games:
    name: deploy games
    needs: setup
    if: inputs.games
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:github
      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_SSH_HOST_KEY: ${{ secrets.SERVER_SSH_HOST_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          printf '%s\n' "$SERVER_SSH_HOST_KEY" >> ~/.ssh/known_hosts
      - name: Deploy games
        env:
          SERVER_USER: ${{ vars.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          ENVIRONMENT: ${{ inputs.environment }}
          STAGING_IMAGE_TAG: ${{ needs.setup.outputs.image-tag }}
        run: |
          ssh -i ~/.ssh/deploy_key \
            "${SERVER_USER}@${SERVER_HOST}" \
            "cd /opt/homelab && ENVIRONMENT='${ENVIRONMENT}' STAGING_IMAGE_TAG='${STAGING_IMAGE_TAG}' bash -s" << 'REMOTE'
          set -euo pipefail
          if [ "${ENVIRONMENT}" = "staging" ]; then
            echo "--- Starting staging games ---"
            STAGING_IMAGE_TAG="${STAGING_IMAGE_TAG}" /opt/homelab/scripts/start_service.sh games --staging
          else
            echo "--- Deploying games ---"
            /opt/homelab/scripts/start_service.sh games
          fi
          REMOTE

  deploy-tools:
    name: deploy tools
    needs: setup
    if: inputs.tools
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:github
      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_SSH_HOST_KEY: ${{ secrets.SERVER_SSH_HOST_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          printf '%s\n' "$SERVER_SSH_HOST_KEY" >> ~/.ssh/known_hosts
      - name: Deploy tools
        env:
          SERVER_USER: ${{ vars.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          ENVIRONMENT: ${{ inputs.environment }}
          STAGING_IMAGE_TAG: ${{ needs.setup.outputs.image-tag }}
        run: |
          ssh -i ~/.ssh/deploy_key \
            "${SERVER_USER}@${SERVER_HOST}" \
            "cd /opt/homelab && ENVIRONMENT='${ENVIRONMENT}' STAGING_IMAGE_TAG='${STAGING_IMAGE_TAG}' bash -s" << 'REMOTE'
          set -euo pipefail
          if [ "${ENVIRONMENT}" = "staging" ]; then
            echo "--- Starting staging tools ---"
            STAGING_IMAGE_TAG="${STAGING_IMAGE_TAG}" /opt/homelab/scripts/start_service.sh tools --staging
          else
            echo "--- Deploying tools ---"
            /opt/homelab/scripts/start_service.sh tools
          fi
          REMOTE

  deploy-travel:
    name: deploy travel
    needs: setup
    if: inputs.travel
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:github
      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_SSH_HOST_KEY: ${{ secrets.SERVER_SSH_HOST_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          printf '%s\n' "$SERVER_SSH_HOST_KEY" >> ~/.ssh/known_hosts
      - name: Deploy travel
        env:
          SERVER_USER: ${{ vars.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          ENVIRONMENT: ${{ inputs.environment }}
          STAGING_IMAGE_TAG: ${{ needs.setup.outputs.image-tag }}
        run: |
          ssh -i ~/.ssh/deploy_key \
            "${SERVER_USER}@${SERVER_HOST}" \
            "cd /opt/homelab && ENVIRONMENT='${ENVIRONMENT}' STAGING_IMAGE_TAG='${STAGING_IMAGE_TAG}' bash -s" << 'REMOTE'
          set -euo pipefail
          if [ "${ENVIRONMENT}" = "staging" ]; then
            echo "--- Starting staging travel ---"
            STAGING_IMAGE_TAG="${STAGING_IMAGE_TAG}" /opt/homelab/scripts/start_service.sh travel --staging
          else
            echo "--- Deploying travel ---"
            /opt/homelab/scripts/start_service.sh travel
          fi
          REMOTE
